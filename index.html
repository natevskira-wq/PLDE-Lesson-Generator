<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLDE // LESSON MANAGER V11.1</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- APP STYLES --- */
        :root {
            --bg: #ffffff;
            --fg: #1a1a1a;
            --accent: #0000ff;
            --danger: #ff0000;
            --border: 3px solid var(--fg);
            --font: 'Courier New', Courier, monospace;
        }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: var(--fg); font-family: var(--font); margin: 0; padding: 0; }
        
        /* PAGE CONTAINERS */
        .page { display: none; padding: 2rem; max-width: 1000px; margin: 0 auto; min-height: calc(100vh - 70px); }
        .page.active { display: block; }
        
        .container { max-width: 1000px; margin: 0 auto; }
        .hidden { display: none !important; }
        .row { display: flex; gap: 1rem; margin-bottom: 1rem; }
        .col { flex: 1; }
        .full-width { width: 100%; }
        
        h1 { font-size: 2rem; border-bottom: var(--border); padding-bottom: 1rem; margin-bottom: 2rem; text-transform: uppercase; }
        h3 { margin-top: 0; text-transform: uppercase; }
        label { display: block; font-weight: bold; font-size: 0.85rem; margin-bottom: 0.4rem; text-transform: uppercase; }
        
        input, select, textarea { width: 100%; padding: 0.8rem; border: 2px solid #ccc; font-family: var(--font); font-size: 1rem; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--accent); color: var(--accent); }

        .btn { background: var(--fg); color: var(--bg); border: none; padding: 0.8rem 1.5rem; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        .btn-outline { background: transparent; border: 2px solid var(--fg); color: var(--fg); }
        .btn-outline:hover { background: #eee; }
        
        /* TOGGLE BUTTON STYLING */
        .btn-toggle { 
            font-size: 0.9rem; 
            padding: 0.6rem 1rem; 
            border: 2px dashed var(--fg); 
            background: #f9f9f9; 
            cursor: pointer; 
            width: 100%;
            text-align: left;
            font-weight: bold;
            margin-top: 1rem;
        }
        .btn-toggle:hover { background: #eee; }

        .btn-delete { background: #ff4444; color: white; padding: 0.4rem 0.8rem; float: right; cursor: pointer; border: none; }
        
        /* CARD STYLES */
        .card { border: var(--border); padding: 1.5rem; margin-bottom: 2rem; background: #fff; box-shadow: 5px 5px 0px rgba(0,0,0,0.1); }
        .card-header { display: flex; justify-content: space-between; margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        .toggle-area { background: #f9f9f9; padding: 1rem; border: 1px dashed #ccc; margin-top: 1rem; }

        /* TIMING OVERRIDE BOX */
        .timing-box { background: #fff8e1; border-color: #ffa000; }
        .calc-display { font-size: 0.75rem; color: #666; margin-bottom: 5px; display: block; font-style: italic; }

        /* BOX STYLES */
        .box-dashed { background: #fdfdfd; border: var(--border); padding: 1.5rem; margin-bottom: 2rem; border-style: dashed; }
        .manager-box { border-color: #00aa00; background: #eeffee; }
        .ai-box { border-color: var(--accent); background: #eef; }
        
        /* DIRECTOR CONSOLE STYLES */
        .director-box {
            background: #f0f0f0;
            border: var(--border);
            padding: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 2rem;
            position: relative;
        }
        .director-box::before {
            content: "üé¨";
            position: absolute;
            top: -15px;
            right: 20px;
            font-size: 2rem;
            background: var(--bg);
            padding: 0 5px;
            z-index: 10;
        }
        
        /* 4-BOX LAYOUT RESTORED */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        @media (max-width: 768px) { .settings-grid { grid-template-columns: 1fr; } }
        
        fieldset { border: 2px solid var(--fg); padding: 1rem; background: #fff; margin: 0; min-height: 100%; }
        legend { font-weight: bold; background: var(--fg); color: var(--bg); padding: 0.2rem 0.5rem; text-transform: uppercase; font-size: 0.85rem; }
        
        .checkbox-group { display: flex; flex-direction: column; gap: 0.6rem; }
        .checkbox-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.9rem; text-transform: none; font-weight: normal; }
        
        /* HELPER TEXT RESTORED */
        .helper-text {
            font-size: 0.75rem;
            color: #666;
            margin-top: -0.2rem;
            margin-bottom: 0.5rem;
            display: block;
            margin-left: 1.8rem; /* Align with checkbox text */
            font-style: italic;
        }

        .status-badge { display: inline-block; padding: 2px 5px; font-size: 0.8rem; border: 1px solid #ccc; margin-top: 5px; background: #fff; }

        /* FOOTER BAR */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; padding: 1rem;
            border-top: var(--border);
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 0.5rem;
            box-shadow: 0 -5px 10px rgba(0,0,0,0.05); z-index: 100;
        }

        .footer-btn, .footer-btn-outline {
            padding: 0.9rem 0.5rem; 
            font-weight: bold; cursor: pointer; text-transform: uppercase;
            font-family: var(--font); font-size: 0.85rem; 
            text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            min-height: 44px; border: 2px solid var(--fg);
        }
        .footer-btn { background: var(--fg); color: var(--bg); border-color: var(--fg); }
        .footer-btn-outline { background: transparent; color: var(--fg); border-color: var(--fg); }
        .footer-btn-outline:hover { background: #f0f0f0; }

        /* PRESET BUTTONS */
        .preset-row { display: flex; gap: 0.5rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed #ccc; align-items: center; }
        .btn-preset { font-size: 0.75rem; padding: 0.4rem 0.8rem; border: 1px solid var(--fg); background: white; cursor: pointer; text-transform: uppercase; }
        .btn-preset:hover { background: var(--fg); color: white; }

        /* LOADING OVERLAY */
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader { width: 50px; height: 50px; border: 5px solid var(--fg); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* PRINT STYLES */
        #print-area { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area { display: block; position: absolute; left: 0; top: 0; width: 100%; padding: 40px; }
            .page, .bottom-bar { display: none; }
            .p-header { border-bottom: 2px solid black; padding-bottom: 15px; margin-bottom: 30px; }
            .match-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            .recall-row { margin-bottom: 25px; break-inside: avoid; }
            .recall-line { display: block; border-bottom: 1px solid black; height: 25px; margin-top: 10px; width: 100%; }
        }

        /* BROWSER PAGE STYLES */
        .lesson-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .lesson-card { border: 2px solid var(--fg); padding: 1.2rem; cursor: pointer; transition: transform 0.2s; background: white; }
        .lesson-card:hover { transform: translateY(-2px); box-shadow: 5px 5px 0 rgba(0,0,0,0.1); }
        .lesson-language { font-size: 1.2rem; font-weight: bold; }
        .lesson-meta { font-size: 0.8rem; color: #666; margin-bottom: 0.5rem; }
        .lesson-actions { margin-top: 1rem; display: flex; gap: 0.5rem; }
        .btn-edit { background: var(--fg); color: white; border: none; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.8rem; flex: 1; }
        .btn-delete-card { background: var(--danger); color: white; border: none; padding: 0.5rem 1rem; cursor: pointer; font-size: 0.8rem; }
        .edit-mode-container { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .btn-clear { background: #ff4444; color: white; border: none; padding: 0.4rem 1rem; cursor: pointer; font-size: 0.8rem; }
        .search-controls { display: grid; grid-template-columns: 1fr auto auto auto auto; gap: 1rem; margin-bottom: 1.5rem; }
        
        /* PRINT PAGE OPTIONS */
        .print-options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .print-section { background: #f9f9f9; padding: 1.5rem; border: 2px solid var(--fg); }
        .print-buttons { display: flex; gap: 0.5rem; margin-top: 1rem; }
        .btn-print-outline { flex: 1; padding: 0.8rem; background: transparent; border: 2px solid var(--fg); font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<!-- MAIN EDITOR PAGE -->
<div id="editor-page" class="page active">
    <div class="container">
        <h1>PLDE // LESSON MANAGER V11.1</h1>

        <!-- Editing Mode Indicator -->
        <div id="edit-mode-container" class="edit-mode-container hidden">
            <div style="color: green; font-weight: bold;">
                ‚úèÔ∏è EDITING MODE ACTIVE
            </div>
            <button class="btn-clear" onclick="clearLoadedLesson()">CLEAR & RESET</button>
        </div>

        <!-- 0b. AI IMPORT STATION -->
        <div class="box-dashed ai-box">
            <h3>ü§ñ AI Import Station</h3>
            <div class="row">
                <div class="col" style="flex: 0 0 150px;">
                    <button class="btn-outline full-width" onclick="copyAiPrompt()">üìã Copy Prompt</button>
                </div>
                <div class="col">
                    <textarea id="ai-input" rows="1" placeholder="Paste JSON from AI here..."></textarea>
                </div>
                <!-- CLEAR BUTTON -->
                <div class="col" style="flex: 0 0 100px;">
                    <button class="btn-outline full-width" onclick="clearAiInput()">üßπ CLEAR</button>
                </div>
                <div class="col" style="flex: 0 0 100px;">
                    <button class="btn full-width" onclick="importJson()">‚ö° PARSE</button>
                </div>
            </div>
        </div>

        <!-- 1. HEADER & META -->
        <div class="section">
            <div class="row">
                <div class="col" style="flex: 2;">
                    <label>Lesson Title</label>
                    <input type="text" id="meta-title" placeholder="e.g. Travel Basics">
                </div>
                <!-- NEW: PRIVATE TOGGLE -->
                <div class="col" style="display:flex; align-items:flex-end; padding-bottom:1rem;">
                    <label class="checkbox-label" style="background:#eee; padding:0.5rem; border:2px solid var(--fg); width:100%; justify-content:center;">
                        <input type="checkbox" id="meta-private" checked> üîí MAKE PRIVATE
                    </label>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label>Native Language</label>
                    <select id="meta-native">
                        <option value="en-US">English (en-US)</option>
                        <option value="de-DE">German (de-DE)</option>
                        <option value="es-ES">Spanish (es-ES)</option>
                        <option value="fr-FR">French (fr-FR)</option>
                        <option value="it-IT">Italian (it-IT)</option>
                        <option value="pt-BR">Portuguese (pt-BR)</option>
                        <option value="ru-RU">Russian (ru-RU)</option>
                        <option value="zh-CN">Chinese (zh-CN)</option>
                        <option value="ko-KR">Korean (ko-KR)</option>
                        <option value="ja-JP">Japanese (ja-JP)</option>
                        <option value="ar-EG">Arabic (ar-EG)</option>
                    </select>
                </div>
                <div class="col">
                    <label>Target Language</label>
                    <select id="meta-target">
                        <option value="en-US">English (en-US)</option>
                        <option value="de-DE">German (de-DE)</option>
                        <option value="es-ES">Spanish (es-ES)</option>
                        <option value="fr-FR">French (fr-FR)</option>
                        <option value="it-IT">Italian (it-IT)</option>
                        <option value="pt-BR">Portuguese (pt-BR)</option>
                        <option value="ru-RU">Russian (ru-RU)</option>
                        <option value="zh-CN">Chinese (zh-CN)</option>
                        <option value="ko-KR">Korean (ko-KR)</option>
                        <option value="ja-JP">Japanese (ja-JP)</option>
                        <option value="ar-EG">Arabic (ar-EG)</option>
                    </select>
                </div>
                <div class="col">
                    <label>Level</label>
                    <select id="meta-level">
                        <option value="A1.1">A1.1</option><option value="A1.2">A1.2</option>
                        <option value="A2.1">A2.1</option><option value="A2.2">A2.2</option>
                        <option value="B1.1">B1.1</option><option value="B1.2">B1.2</option>
                        <option value="B2.1">B2.1</option><option value="B2.2">B2.2</option>
                        <option value="C1">C1</option><option value="C2">C2</option>
                    </select>
                </div>
            </div>

            <!-- TOGGLE BUTTON -->
            <button class="btn-toggle" onclick="toggleId('director-console')">‚ñº üé¨ DIRECTOR CONTROLS & AI SETTINGS (Toggle)</button>

            <!-- DIRECTOR CONSOLE V11 (RESTORED 4-BOX LAYOUT) -->
            <div id="director-console" class="director-box hidden">
                <!-- PRESETS ROW -->
                <div class="preset-row">
                    <span style="font-weight:bold; font-size:0.8rem; margin-right:10px;">QUICK PRESETS:</span>
                    <button class="btn-preset" onclick="applyPreset('standard')">Standard</button>
                    <button class="btn-preset" onclick="applyPreset('audio')">Audio Drill</button>
                    <button class="btn-preset" onclick="applyPreset('reading')">Reading Only</button>
                </div>

                <div class="settings-grid">
                    <!-- BOX 1: DISPLAY -->
                    <fieldset>
                        <legend>1. Display</legend>
                        <div class="checkbox-group">
                            <label class="checkbox-label"><input type="checkbox" id="meta-show-text" checked> Show Trigger Text</label>
                            <span class="helper-text">Uncheck for Audio-Only drills.</span>
                            
                            <label class="checkbox-label"><input type="checkbox" id="meta-show-trans"> Show Translation</label>
                            <span class="helper-text">Shows native meaning.</span>
                            
                            <label class="checkbox-label"><input type="checkbox" id="meta-show-phon"> Show Phonetic</label>
                            <span class="helper-text">For non-Latin scripts.</span>
                            
                            <hr style="width:100%; border:0; border-top:1px dashed #ccc;">
                            <label class="checkbox-label" style="color:red;"><input type="checkbox" id="meta-hide-resp"> HIDE Response (TEST)</label>
                            <span class="helper-text">Student must type without seeing answer.</span>
                        </div>
                    </fieldset>

                    <!-- BOX 2: AUDIO BEHAVIOR -->
                    <fieldset>
                        <legend>2. Audio Behavior</legend>
                        <div class="checkbox-group">
                            <label class="checkbox-label"><input type="checkbox" id="meta-autoplay-imprint"> Auto-Play (Imprint)</label>
                            <span class="helper-text">Plays immediately on new card.</span>
                            
                            <label class="checkbox-label"><input type="checkbox" id="meta-autoplay-drill"> Auto-Play (Drills)</label>
                            <span class="helper-text">Plays audio during exercises.</span>
                        </div>
                    </fieldset>

                    <!-- BOX 3: ENGINE TUNING -->
                    <fieldset>
                        <legend>3. Engine Tuning</legend>
                        <div class="checkbox-group">
                            <label class="checkbox-label"><input type="checkbox" id="meta-strict" checked> Strict Mode</label>
                            <span class="helper-text">Requires perfect spelling.</span>
                            
                            <label class="checkbox-label"><input type="checkbox" id="phase-cumulative" checked> Cumulative Review</label>
                            <span class="helper-text">Periodically review previous items.</span>
                            
                            <label class="checkbox-label"><input type="checkbox" id="meta-random"> Randomize Order</label>
                            <span class="helper-text">Shuffle the sequence.</span>
                            
                            <div style="margin-top:0.5rem;">
                                <label style="font-size:0.75rem;">Voice Threshold (0.1-1.0)</label>
                                <input type="number" id="meta-threshold" step="0.1" min="0.1" max="1.0" value="0.7">
                                <span class="helper-text">0.1 = Forgiving | 1.0 = Strict</span>
                            </div>
                            <div style="margin-top:0.2rem;">
                                <label style="font-size:0.75rem;">Review Interval</label>
                                <input type="number" id="meta-interval" value="3">
                            </div>
                        </div>
                    </fieldset>

                    <!-- BOX 4: LOOP CONFIG -->
                    <fieldset>
                        <legend>4. Loop Config</legend>
                        <div class="checkbox-group">
                            <label class="checkbox-label"><input type="checkbox" id="phase-recog" checked> Enable Recognition</label>
                            <label class="checkbox-label"><input type="checkbox" id="phase-audio-match"> Enable Audio Match</label>
                            <label class="checkbox-label"><input type="checkbox" id="phase-reorder" checked> Enable Reorder</label>
                            <label class="checkbox-label"><input type="checkbox" id="phase-prod" checked> Enable Production</label>
                            <label class="checkbox-label"><input type="checkbox" id="phase-recall" checked> Enable Recall</label>
                            <label class="checkbox-label"><input type="checkbox" id="phase-boss" checked> Enable Final Boss</label>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>

        <hr style="margin: 2rem 0; border: 0; border-top: 2px dashed #ccc;">

        <!-- 2. BUILDER -->
        <div id="links-container"></div>
        <div style="text-align: center; margin-bottom: 4rem;">
            <button class="btn-outline full-width" onclick="addLink()">[ + ADD NEW LINK ]</button>
        </div>
    </div>
</div>

<!-- LESSON BROWSER PAGE -->
<div id="browser-page" class="page">
    <div class="container lesson-browser-page">
        <div class="page-header"><h1>üìÇ LOAD LESSON</h1></div>
        <div class="search-controls">
            <input type="text" id="lesson-search" class="search-box" placeholder="Search title...">
            
            <!-- RESTORED FULL LANGUAGE LISTS -->
            <select id="filter-native" class="filter-select">
                <option value="">Native: Any</option>
                <option value="en-US">English</option>
                <option value="de-DE">German</option>
                <option value="es-ES">Spanish</option>
                <option value="fr-FR">French</option>
                <option value="it-IT">Italian</option>
                <option value="pt-BR">Portuguese</option>
                <option value="ru-RU">Russian</option>
                <option value="zh-CN">Chinese</option>
                <option value="ko-KR">Korean</option>
                <option value="ja-JP">Japanese</option>
                <option value="ar-EG">Arabic</option>
            </select>

            <select id="filter-target" class="filter-select">
                <option value="">Target: Any</option>
                <option value="en-US">English</option>
                <option value="de-DE">German</option>
                <option value="es-ES">Spanish</option>
                <option value="fr-FR">French</option>
                <option value="it-IT">Italian</option>
                <option value="pt-BR">Portuguese</option>
                <option value="ru-RU">Russian</option>
                <option value="zh-CN">Chinese</option>
                <option value="ko-KR">Korean</option>
                <option value="ja-JP">Japanese</option>
                <option value="ar-EG">Arabic</option>
            </select>

            <select id="filter-level" class="filter-select">
                <option value="">Level: Any</option>
                <option value="A1.1">A1.1</option>
                <option value="A1.2">A1.2</option>
                <option value="A2.1">A2.1</option>
                <option value="A2.2">A2.2</option>
                <option value="B1.1">B1.1</option>
                <option value="B1.2">B1.2</option>
                <option value="B2.1">B2.1</option>
                <option value="B2.2">B2.2</option>
                <option value="C1">C1</option>
                <option value="C2">C2</option>
            </select>

            <button class="btn" onclick="searchLessons()">üîç SEARCH</button>
        </div>
        <div id="lesson-grid" class="lesson-grid"></div>
        <div id="no-lessons-message" class="no-results" style="text-align:center;">No lessons loaded. Click Search.</div>
    </div>
</div>

<!-- PRINT PAGE -->
<div id="print-page" class="page">
    <div class="container print-page">
        <div class="page-header"><h1>üñ®Ô∏è PRINT LESSON</h1></div>
        <div class="print-options-grid">
            <div class="print-section"><h3>Part A: Match</h3><div class="print-buttons"><button class="btn-print-outline" onclick="printPartA(false)">Test</button><button class="btn-print-outline" onclick="printPartA(true)">Key</button></div></div>
            <div class="print-section"><h3>Part B: Unscramble</h3><div class="print-buttons"><button class="btn-print-outline" onclick="printPartB(false)">Test</button><button class="btn-print-outline" onclick="printPartB(true)">Key</button></div></div>
            <div class="print-section"><h3>Part C: Translate</h3><div class="print-buttons"><button class="btn-print-outline" onclick="printPartC(false)">Test</button><button class="btn-print-outline" onclick="printPartC(true)">Key</button></div></div>
            <div class="print-section"><h3>Full Test</h3><div class="print-buttons"><button class="btn" style="flex:1" onclick="printAll(false)">FULL TEST</button><button class="btn" style="flex:1" onclick="printAll(true)">FULL KEY</button></div></div>
        </div>
    </div>
</div>

<div id="print-area"></div>
<div id="overlay" class="hidden"><div class="loader"></div><h2 id="overlay-text">WORKING...</h2></div>

<div class="bottom-bar">
    <button class="footer-btn" onclick="showPage('editor-page')">/// EDITOR ///</button>
    <button class="footer-btn-outline" onclick="showPage('browser-page')">üìÇ LOAD</button>
    <button class="footer-btn-outline" onclick="showPage('print-page')">üñ®Ô∏è PRINT</button>
    <button class="footer-btn" id="publish-btn" onclick="publishLesson()">/// PUBLISH ///</button>
</div>

<script>
    const SU_URL = 'https://syrhuxxryctrzjdzexnx.supabase.co';
    const SU_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5cmh1eHhyeWN0cnpqZHpleG54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMjYzMjUsImV4cCI6MjA4MDcwMjMyNX0.DP4O-USLYPbjGoTwM2fSc8juzLsABrDbGpQ-7CxSAXQ';
    
    let client = window.supabase ? window.supabase.createClient(SU_URL, SU_KEY) : null;
    let currentEditId = null; 
    let allLessons = [];
    let adminCode = localStorage.getItem('plde_admin_code');

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if (pageId === 'browser-page') document.getElementById('lesson-grid').innerHTML = '';
    }

    window.onload = async function() { 
        if(!adminCode) {
            adminCode = prompt("üîê ENTER ADMIN ACCESS CODE (Required for Private Lessons):");
            if(adminCode) localStorage.setItem('plde_admin_code', adminCode);
        }

        if(client) await loadAllLessons();
        if (document.querySelectorAll('.card').length === 0) addLink();
    };

    // --- LESSON BROWSER LOGIC ---
    async function loadAllLessons() {
        try {
            const { data, error } = await client.from('lessons').select('id, title, created_at, content').order('created_at', { ascending: false });
            if(error) throw error;
            allLessons = data.map(l => ({
                id: l.id,
                title: l.title || 'Untitled',
                createdAt: l.created_at,
                native: l.content?.meta?.native_language || 'en-US',
                target: l.content?.meta?.target_language || 'en-US',
                level: l.content?.meta?.level || 'A1.1',
                content: l.content
            }));
        } catch(e) { console.error("Error loading lessons:", e); }
    }

    function searchLessons() {
        const term = document.getElementById('lesson-search').value.toLowerCase();
        const nFilter = document.getElementById('filter-native').value;
        const tFilter = document.getElementById('filter-target').value;
        const lFilter = document.getElementById('filter-level').value;
        
        const filtered = allLessons.filter(l => {
            if (term && !l.title.toLowerCase().includes(term)) return false;
            if (nFilter && l.native !== nFilter) return false;
            if (tFilter && l.target !== tFilter) return false;
            if (lFilter && l.level !== lFilter) return false;
            return true;
        });
        
        const grid = document.getElementById('lesson-grid');
        grid.innerHTML = '';
        if (filtered.length === 0) { grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center;">No lessons found.</div>'; return; }

        filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        filtered.forEach(l => {
            const card = document.createElement('div');
            card.className = 'lesson-card';
            card.innerHTML = `
                <div class="lesson-language">${l.native.split('-')[1]} ‚Üí ${l.target.split('-')[1]}</div>
                <div class="lesson-meta">${l.level}</div>
                <div style="font-weight:bold; margin-bottom:0.5rem;">${l.title}</div>
                <div class="lesson-actions">
                    <button class="btn-edit" onclick="loadLessonFromCard('${l.id}')">‚úèÔ∏è EDIT</button>
                    <button class="btn-delete-card" onclick="deleteLesson('${l.id}')">üóëÔ∏è</button>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    async function loadLessonFromCard(id) {
        const overlay = document.getElementById('overlay');
        overlay.classList.remove('hidden');
        try {
            const { data, error } = await client.from('lessons').select('*').eq('id', id).single();
            if(error) throw error;

            currentEditId = data.id;
            document.getElementById('edit-mode-container').classList.remove('hidden');
            document.getElementById('publish-btn').innerText = "/// UPDATE ///";

            populateFormFromData(data.content);
            document.getElementById('meta-title').value = data.title; 
            showPage('editor-page');
            window.scrollTo(0,0);
        } catch(e) { alert(e.message); } finally { overlay.classList.add('hidden'); }
    }

    async function deleteLesson(id) {
        if(!confirm("‚ö†Ô∏è PERMANENTLY DELETE LESSON?")) return;
        const overlay = document.getElementById('overlay');
        overlay.classList.remove('hidden');
        document.getElementById('overlay-text').innerText = "DELETING...";
        const { error } = await client.from('lessons').delete().eq('id', id);
        overlay.classList.add('hidden');
        if(error) alert("Error: " + error.message);
        else {
            alert("Deleted.");
            await loadAllLessons();
            searchLessons();
            if(currentEditId === id) clearLoadedLesson();
        }
    }

    function clearLoadedLesson() {
        if (confirm("Reset form?")) {
            currentEditId = null;
            document.getElementById('edit-mode-container').classList.add('hidden');
            document.getElementById('publish-btn').innerText = "/// PUBLISH ///";
            document.getElementById('meta-title').value = '';
            document.getElementById('links-container').innerHTML = '';
            addLink();
        }
    }

    function clearAiInput() { document.getElementById('ai-input').value = ""; }

    // --- PRESETS ---
    function applyPreset(type) {
        // Defaults
        document.getElementById('meta-show-text').checked = true;
        document.getElementById('meta-show-trans').checked = false;
        document.getElementById('meta-show-phon').checked = false;
        document.getElementById('meta-hide-resp').checked = false; 
        
        document.getElementById('meta-autoplay-imprint').checked = false;
        document.getElementById('meta-autoplay-drill').checked = false;

        document.getElementById('phase-recog').checked = true;
        document.getElementById('phase-audio-match').checked = false;
        document.getElementById('phase-reorder').checked = true;
        document.getElementById('phase-prod').checked = true;
        document.getElementById('phase-recall').checked = true;
        document.getElementById('phase-boss').checked = true;
        document.getElementById('phase-cumulative').checked = true;

        if (type === 'standard') {
            document.getElementById('phase-audio-match').checked = true;
        }
        else if (type === 'audio') {
            document.getElementById('meta-show-text').checked = false; 
            document.getElementById('phase-audio-match').checked = true; 
            document.getElementById('phase-reorder').checked = false; 
            document.getElementById('meta-autoplay-drill').checked = true; 
        }
        else if (type === 'reading') {
            document.getElementById('phase-audio-match').checked = false;
            document.getElementById('phase-prod').checked = false; 
            document.getElementById('phase-recall').checked = false; 
            document.getElementById('phase-boss').checked = false; 
        }
        alert("Preset '" + type.toUpperCase() + "' applied!");
    }

    // --- FORM POPULATION ---
    function populateFormFromData(data) {
        if(data.meta) {
            document.getElementById('meta-title').value = data.meta.title || "";
            // Safe Language Set
            const nDrop = document.getElementById('meta-native');
            if([...nDrop.options].some(o => o.value === data.meta.native_language)) nDrop.value = data.meta.native_language;
            const tDrop = document.getElementById('meta-target');
            if([...tDrop.options].some(o => o.value === data.meta.target_language)) tDrop.value = data.meta.target_language;
            
            // Safe Level Set
            if(data.meta.level) {
                let lvl = data.meta.level.replace(/level/gi, '').trim().toUpperCase();
                if(document.querySelector(`#meta-level option[value='${lvl}']`)) document.getElementById('meta-level').value = lvl;
                else if(["A1","A2","B1","B2"].includes(lvl)) document.getElementById('meta-level').value = lvl + ".1";
            }

            // BOX 1: DISPLAY
            document.getElementById('meta-show-text').checked = data.meta.show_text !== false; 
            document.getElementById('meta-show-trans').checked = !!data.meta.show_translation;
            document.getElementById('meta-show-phon').checked = !!data.meta.show_phonetic;
            document.getElementById('meta-hide-resp').checked = !!data.meta.hide_imprint_response;

            // BOX 2: AUDIO
            document.getElementById('meta-autoplay-imprint').checked = !!data.meta.autoplay_imprint;
            // Legacy mapping: audio_autoplay -> autoplay_drill
            document.getElementById('meta-autoplay-drill').checked = !!data.meta.autoplay_drill || !!data.meta.audio_autoplay;

            // BOX 3: ENGINE
            document.getElementById('meta-strict').checked = data.meta.strict_mode !== false;
            document.getElementById('meta-random').checked = !!data.meta.randomize;
            document.getElementById('meta-threshold').value = data.meta.voice_threshold || 0.7;
            document.getElementById('meta-interval').value = data.meta.cumulative_interval || 3;
            // Loop config might store cumulative in phases or top level, default true
            const p = data.meta.phases || {};
            document.getElementById('phase-cumulative').checked = p.cumulative !== false;

            // BOX 4: LOOP
            document.getElementById('phase-recog').checked = p.recognition !== false; 
            document.getElementById('phase-audio-match').checked = !!p.audio_match;
            document.getElementById('phase-reorder').checked = p.reorder !== false; 
            document.getElementById('phase-prod').checked = p.production !== false; 
            document.getElementById('phase-recall').checked = p.recall !== false; 
            document.getElementById('phase-boss').checked = p.final_boss !== false; 
            
            // PRIVATE CHECKBOX
            document.getElementById('meta-private').checked = !!data.owner_code || !!data.meta.owner_code;
        }

        document.getElementById('links-container').innerHTML = '';
        if(data.links) {
            data.links.forEach(link => {
                addLink(); 
                const card = document.getElementById('links-container').lastElementChild;
                card.querySelector('.input-trigger').value = link.trigger.text || "";
                card.querySelector('.input-response').value = link.response.text || "";
                card.querySelector('.input-translation').value = link.response.translation || "";
                card.querySelector('.input-phonetic').value = link.response.phonetic || "";
                
                updateCardTiming(card.id.replace('link-', ''));

                if(link.steps?.['2_recognition']?.options) {
                    const correct = link.response.text;
                    const distractors = link.steps['2_recognition'].options.filter(o => o !== correct).join(', ');
                    card.querySelector('.input-distractors').value = distractors;
                }

                // File Restoration
                const rest = (type, url) => {
                    if(url && url !== "placeholder") {
                        card.querySelector(type).dataset.existing = url;
                        card.querySelector(type.replace('.f-', '.status-')).innerHTML = "‚úÖ Saved";
                        card.querySelector(type.replace('.f-', '.status-')).classList.remove('hidden');
                    }
                };
                rest('.f-t-img', link.trigger.image_url);
                rest('.f-t-aud', link.trigger.audio_url);
                rest('.f-r-aud', link.response.audio_url);
            });
        }
        updateLinkNumbers();
    }

    // --- TIMING V9.2 ---
    function calcBaseTimes(text) {
        if (!text) return { reorder: 5, prod: 5, recall: 5 };
        const charCount = text.length;
        const wordCount = text.trim().split(/\s+/).length;
        const rawReorder = (2 + (wordCount * 1.5)) * 1.2;
        const rawProd = (2 + (charCount * 0.3)) * 1.2;
        const rawRecall = (2 + (charCount * 0.2)) * 1.2;
        return {
            reorder: Math.max(5, Math.min(60, Math.round(rawReorder))),
            prod: Math.max(5, Math.min(60, Math.round(rawProd))),
            recall: Math.max(5, Math.min(60, Math.round(rawRecall)))
        };
    }

    function updateCardTiming(uid) {
        const card = document.getElementById(`link-${uid}`);
        if(!card) return;
        const text = card.querySelector('.input-response').value.trim();
        const base = calcBaseTimes(text);
        document.getElementById(`base-reorder-${uid}`).innerText = `Base: ${Math.round(base.reorder)}s`;
        document.getElementById(`base-prod-${uid}`).innerText = `Base: ${Math.round(base.prod)}s`;
        document.getElementById(`base-recall-${uid}`).innerText = `Base: ${Math.round(base.recall)}s`;
    }

    // --- AI PROMPT ---
    function copyAiPrompt() {
        const sn = document.getElementById('meta-native').value;
        const st = document.getElementById('meta-target').value;
        const sl = document.getElementById('meta-level').value;
        const p = `ACT AS COUNCIL (Krashen/Nation/DataEng). GENERATE JSON LESSON.
INPUTS: Topic=[INSERT], Native=${sn}, Target=${st}, Level=${sl}, Links=[10].
REQUIREMENTS: Valid JSON only. Phonetics mandated for non-Latin. No trailing punct in response.text.
SCHEMA: {
  "meta": { "title": "Str", "native_language": "${sn}", "target_language": "${st}", "level": "${sl}" },
  "links": [ { "trigger": {"text":""}, "response": {"text":"", "translation":"", "phonetic":""}, "steps": {"2_recognition": {"options":["Correct","Dist1","Dist2"]}} } ]
}`;
        navigator.clipboard.writeText(p);
        alert(`Prompt Copied for ${st} (${sl}).`);
    }

    function importJson() {
        const raw = document.getElementById('ai-input').value;
        if(!raw) return alert("Paste JSON.");
        try {
            currentEditId = null;
            document.getElementById('edit-mode-container').classList.add('hidden');
            document.getElementById('publish-btn').innerText = "/// PUBLISH ///";
            populateFormFromData(JSON.parse(raw));
            alert("Loaded.");
        } catch(e) { alert("Invalid JSON."); }
    }

    // --- UI HELPERS ---
    function updateLinkNumbers() { document.querySelectorAll('.card').forEach((c, i) => { c.querySelector('.link-label').innerText = `LINK #${i + 1}`; }); }
    function toggleId(id) { document.getElementById(id).classList.toggle('hidden'); }
    function removeThisLink(btn) { if(confirm("Delete?")) { btn.closest('.card').remove(); updateLinkNumbers(); } }

    function addLink() {
        const container = document.getElementById('links-container');
        const card = document.createElement('div');
        card.className = 'card';
        const uid = Date.now() + Math.random().toString(36).substr(2, 5);
        const linkId = `link-${uid}`;
        card.id = linkId;
        
        card.innerHTML = `
            <div class="card-header"><strong class="link-label">LINK #</strong><button class="btn-delete" onclick="removeThisLink(this)">X</button></div>
            <div class="row">
                <div class="col"><label>Trigger</label><input type="text" class="input-trigger"></div>
                <div class="col"><label>Response</label><input type="text" class="input-response" onkeyup="updateCardTiming('${uid}')"></div>
            </div>
            <div class="row"><div class="col"><label>Distractors</label><input type="text" class="input-distractors"></div></div>
            <div>
                <button type="button" class="btn-toggle" onclick="toggleId('media-${uid}')">üì∑ Media</button>
                <button type="button" class="btn-toggle" onclick="toggleId('context-${uid}')">üìù Context</button>
                <button type="button" class="btn-toggle" onclick="toggleId('timing-${uid}')">‚è±Ô∏è Timing (Override)</button>
            </div>
            <div id="media-${uid}" class="toggle-area hidden">
                <div class="row"><div class="col"><label>Trigger Img</label><input type="file" class="f-t-img" accept="image/*"><span class="status-badge status-t-img hidden"></span></div></div>
                <div class="row"><div class="col"><label>Trig Aud</label><input type="file" class="f-t-aud" accept="audio/*"><span class="status-badge status-t-aud hidden"></span></div><div class="col"><label>Resp Aud</label><input type="file" class="f-r-aud" accept="audio/*"><span class="status-badge status-r-aud hidden"></span></div></div>
            </div>
            <div id="context-${uid}" class="toggle-area hidden">
                <div class="row"><div class="col"><label>Translation</label><input type="text" class="input-translation"></div><div class="col"><label>Phonetic / IPA</label><input type="text" class="input-phonetic"></div></div>
            </div>
            <div id="timing-${uid}" class="toggle-area hidden timing-box">
                <div class="row">
                    <div class="col"><label>Reorder (Offset)</label><span id="base-reorder-${uid}" class="calc-display">Base: 5s</span><input type="number" class="offset-reorder" value="0" placeholder="+/- Sec"></div>
                    <div class="col"><label>Production (Offset)</label><span id="base-prod-${uid}" class="calc-display">Base: 7s</span><input type="number" class="offset-prod" value="0" placeholder="+/- Sec"></div>
                    <div class="col"><label>Recall (Offset)</label><span id="base-recall-${uid}" class="calc-display">Base: 5s</span><input type="number" class="offset-recall" value="0" placeholder="+/- Sec"></div>
                </div>
            </div>
        `;
        container.appendChild(card);
        updateLinkNumbers();
    }

    async function handleUpload(fileInput) {
        if(fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const path = `${Date.now()}_${file.name.replace(/[^a-zA-Z0-9.]/g, '_')}`;
            await client.storage.from('media').upload(path, file);
            return client.storage.from('media').getPublicUrl(path).data.publicUrl;
        }
        return fileInput.dataset.existing || null;
    }

    async function publishLesson() {
        if(!client) return;
        const overlay = document.getElementById('overlay');
        overlay.classList.remove('hidden');
        document.getElementById('overlay-text').innerText = "PROCESSING...";

        try {
            const phases = {
                recognition: document.getElementById('phase-recog').checked,
                audio_match: document.getElementById('phase-audio-match').checked,
                reorder: document.getElementById('phase-reorder').checked,
                production: document.getElementById('phase-prod').checked,
                recall: document.getElementById('phase-recall').checked,
                final_boss: document.getElementById('phase-boss').checked,
                cumulative: document.getElementById('phase-cumulative').checked
            };

            const isPrivate = document.getElementById('meta-private').checked;
            const ownerCode = isPrivate ? adminCode : null;

            const meta = {
                title: document.getElementById('meta-title').value.trim(),
                native_language: document.getElementById('meta-native').value,
                target_language: document.getElementById('meta-target').value,
                level: document.getElementById('meta-level').value,
                phases: phases,
                hide_imprint_response: document.getElementById('meta-hide-resp').checked,
                autoplay_imprint: document.getElementById('meta-autoplay-imprint').checked,
                autoplay_drill: document.getElementById('meta-autoplay-drill').checked,
                show_text: document.getElementById('meta-show-text').checked,
                show_translation: document.getElementById('meta-show-trans').checked,
                show_phonetic: document.getElementById('meta-show-phon').checked,
                voice_threshold: parseFloat(document.getElementById('meta-threshold').value) || 0.7,
                strict_mode: document.getElementById('meta-strict').checked,
                randomize: document.getElementById('meta-random').checked,
                cumulative_interval: parseInt(document.getElementById('meta-interval').value) || 3
            };
            
            if(!meta.title) throw new Error("Missing Title");
            const cards = document.querySelectorAll('.card');
            if(cards.length === 0) throw new Error("No Links");

            let links = [];
            let warnings = [];

            for(let i=0; i<cards.length; i++) {
                const c = cards[i];
                const tr = c.querySelector('.input-trigger').value.trim();
                const re = c.querySelector('.input-response').value.trim().replace(/[.?!]+$/, "");
                
                if(!tr || !re) throw new Error(`Link #${i+1} incomplete`);

                const uImg = await handleUpload(c.querySelector('.f-t-img'));
                const uAudT = await handleUpload(c.querySelector('.f-t-aud'));
                const uAudR = await handleUpload(c.querySelector('.f-r-aud'));

                if ((meta.autoplay_imprint || meta.autoplay_drill) && !uAudT) {
                    warnings.push(`Link #${i+1}: Auto-Play ON but no Audio.`);
                }

                const disStr = c.querySelector('.input-distractors').value;
                const dists = disStr ? disStr.split(',').map(s=>s.trim()).filter(s=>s) : [];
                const opts = shuffleArray([re, ...dists]);
                
                const charCount = re.length;
                const wc = re.trim().split(/\s+/).length;
                const baseReorder = (2 + (wc * 1.5)) * 1.2;
                const baseProd = (2 + (charCount * 0.3)) * 1.2;
                const baseRecall = (2 + (charCount * 0.2)) * 1.2;

                const offReorder = parseInt(c.querySelector('.offset-reorder').value) || 0;
                const offProd = parseInt(c.querySelector('.offset-prod').value) || 0;
                const offRecall = parseInt(c.querySelector('.offset-recall').value) || 0;

                const t_reorder = Math.max(5, Math.min(60, Math.round(baseReorder + offReorder)));
                const t_type = Math.max(5, Math.min(60, Math.round(baseProd + offProd)));
                const t_recall = Math.max(5, Math.min(60, Math.round(baseRecall + offRecall)));

                let steps = {};
                steps["1_model"] = { type: "imprint", display: ["trigger", "response", "translation", "phonetic", "image"] };
                if(phases.recognition) steps["2_recognition"] = { type: "multiple_choice", time_limit: 10, options: opts };
                if(phases.audio_match) steps["2_5_audio_match"] = { type: "audio_match", time_limit: 10, options: opts };
                if(phases.reorder) steps["3_reorder"] = { type: "sentence_reorder", time_limit: t_reorder };
                if(phases.production) steps["4_production"] = { type: "input_strict", time_limit: t_type, display: ["trigger", "translation"] };
                if(phases.recall) steps["5_timed_recall"] = { type: "input_strict", time_limit: t_recall, display: ["trigger"] };

                links.push({
                    trigger: { text: tr, image_url: uImg, audio_url: uAudT, video_url: null },
                    response: { text: re, audio_url: uAudR, translation: c.querySelector('.input-translation').value, phonetic: c.querySelector('.input-phonetic').value },
                    steps: steps
                });
            }

            if (warnings.length > 0) {
                if (!confirm("‚ö†Ô∏è AUDIO MISSING:\n" + warnings.join("\n") + "\n\nContinue?")) {
                    overlay.classList.add('hidden');
                    return;
                }
            }

            const json = { lesson_id: currentEditId ? `updated_${Date.now()}` : `${meta.target_language}-${meta.level}-${Date.now()}`, meta, links };
            const payload = { title: meta.title, content: json, owner_code: ownerCode };

            if(currentEditId) {
                const { error } = await client.from('lessons').update(payload).eq('id', currentEditId);
                if(error) throw error;
                alert("‚úÖ Updated!");
            } else {
                const { error } = await client.from('lessons').insert([payload]);
                if(error) throw error;
                alert("‚úÖ Published!");
            }
            await loadAllLessons();
            
        } catch(e) { alert(e.message); } finally { overlay.classList.add('hidden'); }
    }

    function shuffleArray(arr) { let a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

    // --- PRINTING ---
    function printSection(section, isKey) {
        const title = document.getElementById('meta-title').value || "Lesson";
        const cards = document.querySelectorAll('.card');
        if(cards.length === 0) return alert("No data");

        let items = [];
        cards.forEach((c, i) => items.push({ 
            id: i+1, 
            t: c.querySelector('.input-trigger').value, 
            r: c.querySelector('.input-response').value, 
            trans: c.querySelector('.input-translation').value 
        }));

        const rnd = document.getElementById('meta-random').checked;
        let mainList = rnd ? shuffleArray([...items]) : [...items];
        let matchingRight = shuffleArray([...items]);

        let html = `<div class="p-header"><h1>${title} ${section!=='ALL'?`[Part ${section}]`:''} ${isKey?'[KEY]':''}</h1><div class="p-meta"><span>Name: ________</span><span>Date: ________</span></div></div>`;
        
        if(section === 'A' || section === 'ALL') {
            html += `<div class="p-section"><div class="p-sec-title">Part A: Match</div><div class="match-grid"><div>`;
            mainList.forEach((it,i) => html+=`<div style="margin-bottom:5px"><strong>${i+1}.</strong> ${it.t}</div>`);
            html += `</div><div>`;
            matchingRight.forEach(it => {
                const num = mainList.findIndex(x=>x.id===it.id)+1;
                html+=`<div style="margin-bottom:5px"><span style="border:1px solid black;padding:0 5px;margin-right:5px">${isKey?num:'&nbsp;&nbsp;'}</span> ${it.r}</div>`;
            });
            html += `</div></div></div>`;
        }
        if(section === 'B' || section === 'ALL') {
            html += `<div class="p-section"><div class="p-sec-title">Part B: Unscramble</div>`;
            mainList.forEach((it,i) => {
                let w = it.r.split(' ');
                if(w.length>1) w=shuffleArray(w);
                html+=`<div class="scramble-row"><strong>${i+1}.</strong> <span class="scramble-words">[ ${w.join('/')} ]</span><div class="scramble-line">${isKey?it.r:''}</div></div>`;
            });
            html+=`</div>`;
        }
        if(section === 'C' || section === 'ALL') {
            html += `<div class="p-section"><div class="p-sec-title">Part C: Translate</div>`;
            mainList.forEach((it,i) => {
                const p = it.trans || it.t;
                html+=`<div class="recall-row"><strong>${i+1}.</strong> ${p}<div class="recall-line">${isKey?it.r:''}</div></div>`;
            });
            html+=`</div>`;
        }

        document.getElementById('print-area').innerHTML = html;
        window.print();
    }
    function printPartA(k){ printSection('A',k); }
    function printPartB(k){ printSection('B',k); }
    function printPartC(k){ printSection('C',k); }
    function printAll(k){ printSection('ALL',k); }
</script>
</body>
</html>
