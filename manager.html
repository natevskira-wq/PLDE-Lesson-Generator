<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLDE // USER MANAGER</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- BRUTALIST THEME --- */
        :root {
            --bg: #ffffff;
            --fg: #000000;
            --accent: #0000ff;
            --danger: #ff0000;
            --border: 3px solid var(--fg);
            --font: 'Courier New', Courier, monospace;
        }
        * { box-sizing: border-box; }
        body { 
            background: var(--bg); color: var(--fg); font-family: var(--font); 
            margin: 0; padding: 2rem; font-size: 14px;
        }

        /* LAYOUT */
        .container { max-width: 1400px; margin: 0 auto; }
        .hidden { display: none !important; }
        .row { display: flex; gap: 1rem; margin-bottom: 1rem; align-items: flex-end; }
        .col { flex: 1; }
        
        /* TYPOGRAPHY */
        h1 { font-size: 2.5rem; margin: 0 0 2rem 0; text-transform: uppercase; border-bottom: var(--border); padding-bottom: 1rem; }
        h2 { font-size: 1.5rem; margin: 0 0 1rem 0; text-transform: uppercase; background: var(--fg); color: var(--bg); display: inline-block; padding: 0.5rem; }
        label { display: block; font-weight: bold; margin-bottom: 0.2rem; text-transform: uppercase; }

        /* INPUTS */
        input, select {
            width: 100%; padding: 0.8rem; 
            border: 2px solid var(--fg); background: #fff;
            font-family: var(--font); font-size: 1rem;
            border-radius: 0;
        }
        input:focus, select:focus { outline: none; background: #eee; }

        /* BUTTONS */
        button {
            padding: 0.8rem 1.5rem; 
            border: 2px solid var(--fg); background: var(--fg); color: var(--bg);
            font-family: var(--font); font-weight: bold; cursor: pointer; text-transform: uppercase;
            transition: transform 0.1s;
        }
        button:hover { opacity: 0.9; }
        button:active { transform: translate(2px, 2px); }
        
        .btn-action { padding: 0.4rem 0.8rem; font-size: 0.8rem; background: white; color: black; }
        .btn-action:hover { background: #eee; }
        .btn-danger { background: var(--danger); border-color: var(--danger); color: white; }
        .btn-danger:hover { background: #cc0000; }

        /* SECTIONS */
        .panel { border: var(--border); padding: 1.5rem; margin-bottom: 3rem; background: #fdfdfd; }
        
        /* DATA GRID */
        .data-grid {
            width: 100%; border-collapse: collapse; border: var(--border);
            font-size: 0.9rem;
        }
        .data-grid th {
            background: var(--fg); color: var(--bg); text-align: left; padding: 1rem;
            text-transform: uppercase; border: 1px solid var(--bg);
        }
        .data-grid td {
            padding: 0.5rem; border-bottom: 1px solid #ccc; border-right: 1px solid #ccc;
            vertical-align: middle;
        }
        .data-grid tr:hover { background: #f0f0f0; }
        
        .cell-input { border: 1px dashed #999; padding: 0.4rem; width: 100%; }
        .cell-select { border: 1px dashed #999; padding: 0.4rem; }

        /* BADGES */
        .badge { padding: 2px 6px; font-weight: bold; border: 1px solid black; font-size: 0.7rem; margin-right: 2px; }
        .tag-gen { margin-top: 1rem; padding: 1rem; border: 1px dashed black; background: #eee; font-family: monospace; white-space: pre-wrap; }

        /* AUTH SCREEN */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<!-- 1. AUTH SCREEN -->
<div id="auth-screen">
    <div style="border: var(--border); padding: 3rem; width: 400px; text-align: center;">
        <h1>SYSTEM LOCKED</h1>
        <p>ENTER SUPER ADMIN KEY</p>
        <button onclick="initAuth()">AUTHENTICATE</button>
        <p id="auth-msg" style="margin-top:1rem; color:red;"></p>
    </div>
</div>

<!-- 2. MAIN DASHBOARD -->
<div id="dashboard" class="container hidden">
    <header style="display:flex; justify-content:space-between; align-items:center;">
        <h1>USER MANAGEMENT CONSOLE</h1>
        <button onclick="location.reload()" style="background:white; color:black;">LOGOUT</button>
    </header>

    <!-- A. USER FACTORY -->
    <div class="panel">
        <h2>üè≠ User Factory (Batch Generator)</h2>
        <div class="row">
            <div class="col">
                <label>Role</label>
                <select id="gen-role">
                    <option value="user">User (Student)</option>
                    <option value="creator">Creator (Teacher)</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <div class="col" style="flex: 2;">
                <label>License Tags (Comma Separated)</label>
                <input type="text" id="gen-licenses" placeholder="e.g. de-en-A1, kr-en-ALL" value="all">
            </div>
            <div class="col">
                <label>Count</label>
                <input type="number" id="gen-count" value="1" min="1" max="50">
            </div>
            <div class="col">
                <label>&nbsp;</label>
                <button onclick="generateUsers()" style="width:100%;">‚ö° GENERATE</button>
            </div>
        </div>
        <div id="gen-output" class="tag-gen hidden"></div>
    </div>

    <!-- B. USER BROWSER -->
    <div class="panel">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
            <h2>üóÑÔ∏è User Database</h2>
            <div class="row" style="margin:0; gap:0.5rem;">
                <input type="text" id="search-input" placeholder="Search Code..." onkeyup="filterGrid()">
                <select id="filter-role" onchange="filterGrid()" style="width:150px;">
                    <option value="all">All Roles</option>
                    <option value="user">User</option>
                    <option value="creator">Creator</option>
                    <option value="admin">Admin</option>
                </select>
                <button onclick="fetchUsers()">‚Üª REFRESH</button>
            </div>
        </div>

        <table class="data-grid">
            <thead>
                <tr>
                    <th style="width: 120px;">CODE</th>
                    <th style="width: 100px;">ROLE</th>
                    <th>LICENSES (EDITABLE)</th>
                    <th style="width: 100px;">DEVICES</th>
                    <th style="width: 80px;">PROG</th>
                    <th style="width: 250px;">ACTIONS</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
                <!-- Data injected here -->
            </tbody>
        </table>
    </div>
</div>

<script>
    // 1. SUPABASE CONFIG
    const SU_URL = 'https://syrhuxxryctrzjdzexnx.supabase.co';
    const SU_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN5cmh1eHhyeWN0cnpqZHpleG54Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxMjYzMjUsImV4cCI6MjA4MDcwMjMyNX0.DP4O-USLYPbjGoTwM2fSc8juzLsABrDbGpQ-7CxSAXQ';
    
    // Initialize Client (Using 'db' to avoid naming conflicts)
    const db = window.supabase.createClient(SU_URL, SU_KEY);

    // 2. AUTHENTICATION
    async function initAuth() {
        const inputKey = prompt("ENTER SUPER ADMIN KEY:");
        if (!inputKey) return;

        document.getElementById('auth-msg').innerText = "VERIFYING...";

        // Check if the entered code exists and is an admin
        const { data, error } = await db
            .from('user_profiles')
            .select('*')
            .eq('access_code', inputKey)  // CHANGED: code -> access_code
            .eq('role', 'admin')
            .single();

        if (error || !data) {
            document.body.innerHTML = "<div style='display:flex;height:100vh;justify-content:center;align-items:center;background:black;color:red;font-family:monospace;font-size:3rem;font-weight:bold;'>ACCESS DENIED</div>";
        } else {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            fetchUsers();
        }
    }

    // 3. GENERATOR LOGIC
    async function generateUsers() {
        const role = document.getElementById('gen-role').value;
        const licensesRaw = document.getElementById('gen-licenses').value;
        const count = parseInt(document.getElementById('gen-count').value);
        
        // Parse licenses into array
        const licenses = licensesRaw.split(',').map(s => s.trim()).filter(s => s.length > 0);
        
        const newUsers = [];
        const codes = [];

        for (let i = 0; i < count; i++) {
            // Generate Code: XXXX-XXXX
            const p1 = Math.random().toString(36).substring(2, 6).toUpperCase();
            const p2 = Math.random().toString(36).substring(2, 6).toUpperCase();
            const code = `${p1}-${p2}`;
            
            newUsers.push({
                access_code: code,  // CHANGED: code -> access_code
                role: role,
                licenses: licenses,
                created_at: new Date()
            });
            codes.push(code);
        }

        const { error } = await db.from('user_profiles').insert(newUsers);

        if (error) {
            alert("Error generating users: " + error.message);
        } else {
            // Show result box
            const out = document.getElementById('gen-output');
            out.classList.remove('hidden');
            out.innerText = "GENERATED CODES (COPY NOW):\n\n" + codes.join('\n');
            fetchUsers();
        }
    }

    // 4. BROWSER LOGIC
    let allUsers = [];

    async function fetchUsers() {
        const tbody = document.getElementById('user-table-body');
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">LOADING DATA...</td></tr>';

        // Fetch Users
        const { data: users, error } = await db
            .from('user_profiles')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) return alert(error.message);

        // Fetch Progress Counts
        const { data: progress } = await db.from('user_progress').select('user_code');
        
        // Map progress count
        const progressMap = {};
        if(progress) {
            progress.forEach(p => {
                progressMap[p.user_code] = (progressMap[p.user_code] || 0) + 1;
            });
        }

        // CHANGED: u.code -> u.access_code
        allUsers = users.map(u => ({
            ...u,
            progressCount: progressMap[u.access_code] || 0
        }));

        renderGrid(allUsers);
    }

    function renderGrid(users) {
        const tbody = document.getElementById('user-table-body');
        tbody.innerHTML = '';

        users.forEach(u => {
            const tr = document.createElement('tr');
            // CHANGED: All u.code -> u.access_code
            tr.innerHTML = `
                <td style="font-weight:bold; color:var(--accent); cursor:pointer;" onclick="navigator.clipboard.writeText('${u.access_code}'); alert('Copied: ${u.access_code}')" title="Click to Copy">${u.access_code}</td>
                <td>
                    <select id="role-${u.access_code}" class="cell-select">
                        <option value="user" ${u.role === 'user' ? 'selected' : ''}>User</option>
                        <option value="creator" ${u.role === 'creator' ? 'selected' : ''}>Creator</option>
                        <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>Admin</option>
                    </select>
                </td>
                <td>
                    <input type="text" id="lic-${u.access_code}" class="cell-input" value="${Array.isArray(u.licenses) ? u.licenses.join(', ') : ''}">
                </td>
                <td>
                    ${u.device_1 ? '<span class="badge" style="background:#ffcccc">D1</span>' : '<span class="badge" style="background:#ccffcc">_</span>'}
                    ${u.device_2 ? '<span class="badge" style="background:#ffcccc">D2</span>' : '<span class="badge" style="background:#ccffcc">_</span>'}
                </td>
                <td style="font-weight:bold;">${u.progressCount}</td>
                <td>
                    <button class="btn-action" onclick="saveUser('${u.access_code}')">üíæ SAVE</button>
                    <button class="btn-action" onclick="resetDevices('${u.access_code}')">üì± RESET</button>
                    <button class="btn-action btn-danger" onclick="deleteUser('${u.access_code}')">X</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    // 5. ACTIONS
    async function saveUser(access_code) {  // CHANGED: parameter name
        const newRole = document.getElementById(`role-${access_code}`).value;
        const licText = document.getElementById(`lic-${access_code}`).value;
        const newLicenses = licText.split(',').map(s => s.trim()).filter(s => s);

        const { error } = await db
            .from('user_profiles')
            .update({ role: newRole, licenses: newLicenses })
            .eq('access_code', access_code);  // CHANGED: code -> access_code

        if(error) alert("Save Failed: " + error.message);
        else {
            // Visual feedback
            const btn = document.activeElement;
            const originalText = btn.innerText;
            btn.innerText = "OK!";
            setTimeout(() => btn.innerText = originalText, 1000);
        }
    }

    async function resetDevices(access_code) {  // CHANGED: parameter name
        if(!confirm(`Clear device slots for ${access_code}?`)) return;
        const { error } = await db
            .from('user_profiles')
            .update({ device_1: null, device_2: null })
            .eq('access_code', access_code);  // CHANGED: code -> access_code
        
        if(error) alert(error.message);
        else fetchUsers();
    }

    async function deleteUser(access_code) {  // CHANGED: parameter name
        if(!confirm(`‚ö†Ô∏è DELETE USER ${access_code}?\nThis cannot be undone.`)) return;
        const { error } = await db.from('user_profiles').delete().eq('access_code', access_code);  // CHANGED: code -> access_code
        if(error) alert(error.message);
        else fetchUsers();
    }

    // 6. FILTERING
    function filterGrid() {
        const term = document.getElementById('search-input').value.toLowerCase();
        const roleFilter = document.getElementById('filter-role').value;

        const filtered = allUsers.filter(u => {
            const matchesSearch = u.access_code.toLowerCase().includes(term);  // CHANGED: u.code -> u.access_code
            const matchesRole = roleFilter === 'all' || u.role === roleFilter;
            return matchesSearch && matchesRole;
        });

        renderGrid(filtered);
    }

</script>
</body>
</html>